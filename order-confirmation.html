<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Confirmed - Tezzon Charge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .confirmation-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .success-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .success-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }
        
        .success-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .order-content {
            padding: 40px 30px;
        }
        
        .info-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #4CAF50;
        }
        
        .order-item-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        
        .order-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .price-highlight {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .status-badge {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        
        .loading-text {
            color: #6c757d;
            font-style: italic;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #f5c6cb;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0,0,0,0.1); backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-bolt me-2"></i>Tezzon Charge
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="products.html">Products</a>
                <a class="nav-link" href="billing.html">Cart</a>
            </div>
        </div>
    </nav>

    <div class="confirmation-container">
        <div class="success-card">
            <!-- Success Header -->
            <div class="success-header">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h1 class="display-4 fw-bold mb-3">Order Confirmed!</h1>
                <p class="lead mb-0">Thank you for choosing Tezzon Charge. Your order has been successfully placed.</p>
            </div>

            <!-- Order Content -->
            <div class="order-content">
                <!-- Error Message (hidden by default) -->
                <div id="errorMessage" class="error-message" style="display: none;">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Order</h5>
                    <p id="errorText">There was an error loading your order details. Please try refreshing the page.</p>
                    <button class="btn btn-primary" onclick="loadOrderData()">Retry</button>
                </div>

                <!-- Order Information -->
                <div id="orderInfo" style="display: none;">
                    <!-- Customer Details -->
                    <div class="info-section">
                        <h4 class="text-primary mb-3">
                            <i class="fas fa-user me-2"></i>Customer Information
                        </h4>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> <span id="customerName">-</span></p>
                                <p><strong>Email:</strong> <span id="customerEmail">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Phone:</strong> <span id="customerPhone">-</span></p>
                                <p><strong>Address:</strong> <span id="customerAddress">-</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="info-section">
                        <h4 class="text-primary mb-3">
                            <i class="fas fa-receipt me-2"></i>Order Summary
                        </h4>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Order Number:</strong> <span id="orderNumber" class="text-primary">-</span></p>
                                <p><strong>Order Date:</strong> <span id="orderDate">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total Amount:</strong> <span id="totalAmount" class="price-highlight">-</span></p>
                                <p><strong>Status:</strong> <span class="status-badge">Confirmed</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="info-section">
                        <h4 class="text-primary mb-3">
                            <i class="fas fa-shopping-bag me-2"></i>Order Items
                        </h4>
                        <div id="orderItems">
                            <!-- Items will be loaded here -->
                        </div>
                    </div>

                    <!-- Next Steps -->
                    <div class="info-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                        <h4 class="text-primary mb-3">
                            <i class="fas fa-route me-2"></i>What's Next?
                        </h4>
                        <div class="row">
                            <div class="col-md-3 text-center mb-3">
                                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <p class="mt-2 mb-0"><strong>Order Placed</strong></p>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <p class="mt-2 mb-0"><strong>Processing</strong></p>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-truck"></i>
                                </div>
                                <p class="mt-2 mb-0"><strong>Shipping</strong></p>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-home"></i>
                                </div>
                                <p class="mt-2 mb-0"><strong>Delivered</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center mt-4">
                        <a href="products.html" class="action-btn">
                            <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
                        </a>
                        <a href="customer-dashboard.html" class="action-btn">
                            <i class="fas fa-tachometer-alt me-2"></i>View Dashboard
                        </a>
                        <button class="action-btn" onclick="downloadInvoice()">
                            <i class="fas fa-download me-2"></i>Download Invoice
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="loading-text">Loading your order details...</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let orderData = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Order confirmation page loaded');
            
            // Test if all required elements exist
            const requiredElements = [
                'loadingState', 'orderInfo', 'customerName', 'customerEmail', 
                'customerPhone', 'customerAddress', 'orderNumber', 'orderDate', 'totalAmount', 'orderItems'
            ];
            
            requiredElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`Element ${id} found`);
                } else {
                    console.error(`Element ${id} NOT found`);
                }
            });
            
            loadOrderData();
        });

        // Main function to load order data
        function loadOrderData() {
            try {
                console.log('Loading order data...');
                
                // Hide error message
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.style.display = 'none';
                }
                
                // Get order data from localStorage
                const storedData = localStorage.getItem('lastOrder');
                console.log('Stored data:', storedData);
                
                if (!storedData) {
                    console.log('No order data found');
                    showError('No order data found. Please place an order first.');
                    return;
                }
                
                // Parse the data
                orderData = JSON.parse(storedData);
                console.log('Parsed order data:', orderData);
                console.log('Order data keys:', Object.keys(orderData));
                console.log('Cart data:', orderData.cart);
                
                // Validate the data
                if (!orderData || !orderData.cart || orderData.cart.length === 0) {
                    console.log('Invalid order data - missing cart or empty cart');
                    showError('Invalid order data. Please place an order first.');
                    return;
                }
                
                console.log('Data validation passed, calling displayOrderData...');
                
                // Quick test - show data in console
                console.log('=== QUICK TEST ===');
                console.log('Customer Name:', orderData.fullName);
                console.log('Email:', orderData.email);
                console.log('Total:', orderData.total);
                console.log('Cart Items:', orderData.cart.length);
                console.log('==================');
                
                // Display the order data
                displayOrderData(orderData);
                
            } catch (error) {
                console.error('Error loading order data:', error);
                showError('Error loading order data: ' + error.message);
            }
        }

        // Display order data on the page
        function displayOrderData(data) {
            try {
                console.log('Displaying order data:', data);
                
                // Hide loading state
                const loadingState = document.getElementById('loadingState');
                if (loadingState) {
                    loadingState.style.display = 'none';
                    console.log('Loading state hidden');
                } else {
                    console.error('Loading state element not found');
                }
                
                // Show order info
                const orderInfo = document.getElementById('orderInfo');
                if (orderInfo) {
                    orderInfo.style.display = 'block';
                    console.log('Order info shown');
                } else {
                    console.error('Order info element not found');
                }
                
                // Fill customer information
                const customerName = document.getElementById('customerName');
                const customerEmail = document.getElementById('customerEmail');
                const customerPhone = document.getElementById('customerPhone');
                const customerAddress = document.getElementById('customerAddress');
                
                if (customerName) {
                    customerName.textContent = data.fullName || 'Not provided';
                    console.log('Customer name set:', data.fullName);
                }
                if (customerEmail) {
                    customerEmail.textContent = data.email || 'Not provided';
                    console.log('Customer email set:', data.email);
                }
                if (customerPhone) {
                    customerPhone.textContent = data.phone || 'Not provided';
                    console.log('Customer phone set:', data.phone);
                }
                if (customerAddress) {
                    const address = `${data.address || ''}, ${data.city || ''} ${data.pincode || ''}`.trim() || 'Not provided';
                    customerAddress.textContent = address;
                    console.log('Customer address set:', address);
                }
                
                // Fill order details
                const orderNumber = document.getElementById('orderNumber');
                const orderDate = document.getElementById('orderDate');
                const totalAmount = document.getElementById('totalAmount');
                
                if (orderNumber) {
                    orderNumber.textContent = data.orderNumber || 'TC-' + Date.now();
                    console.log('Order number set:', data.orderNumber);
                }
                if (orderDate) {
                    const date = data.orderDate ? new Date(data.orderDate).toLocaleDateString() : new Date().toLocaleDateString();
                    orderDate.textContent = date;
                    console.log('Order date set:', date);
                }
                if (totalAmount) {
                    totalAmount.textContent = data.total || '₹0';
                    console.log('Total amount set:', data.total);
                }
                
                // Display order items
                displayOrderItems(data.cart);
                
                // Force show the order info section
                const orderInfoElement = document.getElementById('orderInfo');
                if (orderInfoElement) {
                    orderInfoElement.style.display = 'block';
                    orderInfoElement.style.visibility = 'visible';
                    orderInfoElement.style.opacity = '1';
                    console.log('Force showing order info');
                }
                
                console.log('Order data displayed successfully');
                
            } catch (error) {
                console.error('Error displaying order data:', error);
                showError('Error displaying order data: ' + error.message);
            }
        }

        // Display order items
        function displayOrderItems(items) {
            const container = document.getElementById('orderItems');
            
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-muted">No items found</p>';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="order-item-card">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-1">${item.product || 'Unknown Product'}</h6>
                            <small class="text-muted">₹${(item.price || 0).toLocaleString()} each</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="badge bg-secondary">Qty: ${item.quantity || 0}</span>
                        </div>
                        <div class="col-md-3 text-end">
                            <strong class="price-highlight">₹${(item.total || 0).toLocaleString()}</strong>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show error message
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('orderInfo').style.display = 'none';
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        // Download invoice
        function downloadInvoice() {
            if (!orderData) {
                alert('No order data available');
                return;
            }
            
            try {
                const invoiceContent = generateInvoice(orderData);
                downloadFile(invoiceContent, `Invoice_${orderData.orderNumber || 'TC-UNKNOWN'}.html`);
                alert('Invoice downloaded successfully!');
            } catch (error) {
                console.error('Error downloading invoice:', error);
                alert('Error downloading invoice: ' + error.message);
            }
        }

        // Generate invoice HTML
        function generateInvoice(data) {
            const items = data.cart || [];
            const subtotal = items.reduce((sum, item) => sum + (item.total || 0), 0);
            const gst = subtotal * 0.18;
            const shipping = subtotal > 50000 ? 0 : 2000;
            const total = subtotal + gst + shipping;
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice ${data.orderNumber || 'TC-UNKNOWN'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; color: #4CAF50; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
                        th { background: #f2f2f2; }
                        .total { font-weight: bold; }
                        .footer { margin-top: 30px; text-align: center; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Tezzon Charge Invoice</h1>
                        <p>Invoice #${data.orderNumber || 'TC-UNKNOWN'}</p>
                        <p>Date: ${new Date(data.orderDate || Date.now()).toLocaleDateString()}</p>
                    </div>
                    
                    <h3>Customer Details</h3>
                    <p><strong>Name:</strong> ${data.fullName || 'N/A'}</p>
                    <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>
                    <p><strong>Address:</strong> ${data.address || 'N/A'}, ${data.city || ''} ${data.pincode || ''}</p>
                    
                    <h3>Order Items</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td>${item.product || 'Unknown Product'}</td>
                                    <td>${item.quantity || 0}</td>
                                    <td>₹${(item.price || 0).toFixed(2)}</td>
                                    <td>₹${(item.total || 0).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                            <tr class="total">
                                <td colspan="3">Subtotal</td>
                                <td>₹${subtotal.toFixed(2)}</td>
                            </tr>
                            <tr class="total">
                                <td colspan="3">GST (18%)</td>
                                <td>₹${gst.toFixed(2)}</td>
                            </tr>
                            <tr class="total">
                                <td colspan="3">Shipping</td>
                                <td>₹${shipping.toFixed(2)}</td>
                            </tr>
                            <tr class="total">
                                <td colspan="3">Grand Total</td>
                                <td>₹${total.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Thank you for choosing Tezzon Charge! ⚡</p>
                        <p>This is a computer-generated invoice.</p>
                    </div>
                </body>
                </html>
            `;
        }

        // Download file function
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>